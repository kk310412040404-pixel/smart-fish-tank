<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>User Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  
  <link rel="stylesheet" href="style_user.css"> 
  
  <link href="https://cdn.jsdelivr.net/npm/gridstack@7.2.3/dist/gridstack.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/gridstack@7.2.3/dist/gridstack-all.js"></script>
  
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="theme-default">

  <div id="toast-box"></div>

  <div class="sidebar">
    <h2><i class="fas fa-fish"></i> Smart Tank</h2>
    <ul>
      <li class="active" onclick="showPage('monitor')">
          <i class="fas fa-chart-line"></i> Giám sát
      </li>
      <li onclick="showPage('control')">
          <i class="fas fa-gamepad"></i> Điều khiển
      </li>
      <li onclick="showPage('settings')">
          <i class="fas fa-cog"></i> Cài đặt
      </li>
      <li class="logout-btn" onclick="logout()">
          <i class="fas fa-sign-out-alt"></i> Đăng xuất
      </li>
    </ul>
  </div>

  <div class="main-content">
    
    <div id="monitor" class="page active">
        <div class="page-header">
            <h3>Giám sát hệ thống</h3>
            <small>Theo dõi các thông số cảm biến và camera</small>
        </div>
        <div class="grid-stack" id="grid-monitor"></div>
    </div>

    <div id="control" class="page">
        <div class="page-header">
            <h3>Bảng điều khiển</h3>
            <small>Tác động trạng thái thiết bị (Bơm, Đèn...)</small>
        </div>
        <div class="grid-stack" id="grid-control"></div>
    </div>

    <div id="settings" class="page">
        <h3>Cài đặt tài khoản</h3>
        
        <div class="settings-container">
            <div class="card">
                <h4>Thông tin cá nhân</h4>
                <div class="form-group">
                    <label>Họ và tên</label>
                    <input type="text" id="st_fullname">
                </div>
                <div class="form-group">
                    <label>Vai trò</label>
                    <input type="text" id="st_role" disabled style="background:#334155; color:#94a3b8;">
                </div>
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="st_username" disabled style="background:#334155; color:#94a3b8;">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="text" id="st_email" disabled style="background:#334155; color:#94a3b8;">
                </div>
                <div class="form-group">
                    <label>Ngày tham gia</label>
                    <input type="text" id="st_created" disabled style="background:#334155; color:#94a3b8;">
                </div>
                <button class="btn-save" onclick="updateUserInfo()">Cập nhật thông tin</button>
            </div>

            <div class="card">
                <h4>Giao diện</h4>
                <div class="theme-selector">
                    <div class="theme-box t-default selected" onclick="changeTheme('default')"></div>
                    <div class="theme-box t-ocean" onclick="changeTheme('ocean')"></div>
                    <div class="theme-box t-forest" onclick="changeTheme('forest')"></div>
                    <div class="theme-box t-light" onclick="changeTheme('light')"></div>
                </div>

                <h4 style="margin-top:30px;">Bảo mật</h4>
                <div class="security-option">
                    <label class="radio-container">
                        <input type="radio" name="sec_mode" id="sec_normal" value="normal" onclick="handleSecurityClick('normal')">
                        <span class="checkmark"></span>
                        <div>
                            <b>Cơ bản</b>
                            <p>Đăng nhập bằng Mật khẩu thường.</p>
                        </div>
                    </label>
                    <label class="radio-container">
                        <input type="radio" name="sec_mode" id="sec_advanced" value="advanced" onclick="handleSecurityClick('advanced')">
                        <span class="checkmark"></span>
                        <div>
                            <b>Nâng cao (2 Lớp)</b>
                            <p>Xác thực qua SĐT khi đăng nhập lạ.</p>
                        </div>
                    </label>
                </div>

                <div class="form-group" style="margin-top:15px;">
                    <label>Số điện thoại xác thực:</label>
                    <input type="text" id="st_phone" disabled placeholder="Chưa đăng ký">
                </div>
                <p id="sec_hint" style="font-size:12px; color:#aaa; margin-top:-10px; margin-bottom:20px;">Chế độ hiện tại: ...</p>

                <button class="btn-outline" onclick="openModal('repassModal')">Đổi mật khẩu</button>
            </div>
        </div>
    </div>
  </div>

  <div id="repassModal" class="modal">
    <div class="modal-content sm">
      <div class="modal-header-icon"><i class="fas fa-lock"></i></div>
      <h3 style="text-align:center; margin-bottom: 10px;">Đổi mật khẩu</h3>
      
      <div class="form-group">
          <label>Nhập mã OTP (Gửi về Email)</label>
          <div style="display:flex; gap:10px;">
              <input type="text" id="pass_otp" placeholder="Mã 6 số...">
              <button id="btnGetPassOTP" class="btn-small" onclick="sendPasswordOTP()">Lấy mã</button>
          </div>
          <small id="otp_msg"></small>
      </div>

      <div class="form-group">
          <label>Mật khẩu mới</label>
          <input type="password" id="new_pass" placeholder="Nhập mật khẩu mới...">
      </div>
      <div class="form-group">
          <input type="password" id="confirm_new_pass" placeholder="Nhập lại mật khẩu mới...">
      </div>

      <div class="modal-buttons">
        <button class="btn-cancel" onclick="closeModal('repassModal')">Hủy</button>
        <button class="btn-save" onclick="doChangePassword()">Lưu</button>
      </div>
    </div>
  </div>

  <div id="rephoneModal" class="modal">
    <div class="modal-content sm">
      <div class="modal-header-icon"><i class="fas fa-shield-alt"></i></div>
      <h3 style="text-align:center; margin-bottom: 10px;">Bảo mật tài khoản</h3>
      <p class="modal-desc">Nhập số điện thoại để bật tính năng xác thực 2 lớp.</p>
      
      <div class="phone-input-group">
          <div class="phone-prefix"><i class="fas fa-flag"></i> +84</div>
          <input type="text" id="new_phone" placeholder="Nhập số điện thoại..." maxlength="10">
      </div>

      <div class="form-group">
          <label style="font-size:12px; color:#94a3b8; margin-bottom:5px;">Xác nhận mật khẩu hiện tại</label>
          <input type="password" id="confirm_pass_for_phone" placeholder="Nhập mật khẩu...">
      </div>

      <div class="modal-buttons">
        <button class="btn-cancel" onclick="closeModal('rephoneModal'); forceDefaultSecurity();">Hủy</button>
        <button class="btn-save" onclick="savePhoneNumber()">Lưu bảo mật</button>
      </div>
    </div>
  </div>

  <script src="script_user.js"></script>
</body>
</html>
